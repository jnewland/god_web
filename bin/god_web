#!/usr/bin/env ruby

require 'rubygems'
require 'god'
require 'sinatra'
require 'stringio'
require 'yaml'
#included until http://sinatra.lighthouseapp.com/projects/9779/tickets/16-patch-http-authentication is in a released version
require File.dirname(__FILE__) + '/../lib/sinatra_http_auth'

config = {
  'god_port' =>  17165,
  'username' =>  nil,
  'password' =>  nil
}
begin
  config.merge!(YAML.load(File.read(ARGV[0])))
rescue
end

before do
  unless config['username'].nil? && config['password'].nil?
    authenticate_or_request_with_http_basic "GodWeb" do
      |user, pass| user == config['username'] && pass == config['password']
    end
  end
end

def with_captured_stdout(&block)
  io = StringIO.new
  $stdout = io
  yield
  $stdout = STDOUT
  io.string
end

get '/' do
  with_captured_stdout do
    response.header['Content-Type'] = 'text/plain'
    God::CLI::Command.new('status', {:port => config['god_port']}, [])
  end
end
