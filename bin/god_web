#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/environment'

before do
  unless GODWEB_CONFIG['username'].nil? && GODWEB_CONFIG['password'].nil?
    authenticate_or_request_with_http_basic "GodWeb" do
      |user, pass| user == GODWEB_CONFIG['username'] && pass == GODWEB_CONFIG['password']
    end
  end
  GODWEB.ping
end

get '/' do
  @status = GODWEB.status
  show(:status)
end

get '/w/:watch' do
  @watch = params["watch"]
  @status = GODWEB.status[@watch][:state]
  @commands = GodWeb.possible_statuses(@status)
  show(:watch, "#{@watch} [#{@status}]")
end

get '/w/:watch/:command' do
  @watch = params["watch"]
  @command = params["command"]
  @success = GODWEB.send(@command, @watch)
  show(:command, "#{@command}ing #{@watch}")
end

private

  def show(template, title = 'GodWeb')
    @title = title
    erb(template, :views_directory => File.dirname(__FILE__) + "/../views")
  end
  